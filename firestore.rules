rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    /* -----------------------------
       Helper functions
    ------------------------------*/
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Admin = either custom claim admin=true OR specific admin email
    function isAdmin() {
      return isSignedIn() &&
        (
          (request.auth.token.admin == true) ||
          (request.auth.token.email == "admin@leadcrm.com")
        );
    }

    /* -----------------------------
       LEADS (CRM + Mobile App)
    ------------------------------*/
    match /leads/{leadId} {
      // Read & write allowed for all authenticated users
      allow read, write: if isSignedIn();
    }

    /* -----------------------------
       ATTENDANCE (Mobile App + CRM)
    ------------------------------*/
    match /attendance/{attendanceId} {
      // Attendance read/write allowed for authenticated users
      allow read, write: if isSignedIn();
    }

    /* -----------------------------
       USERS (Admin + Agents)
    ------------------------------*/
    match /users/{userId} {

      // Everyone logged in can read user list
      allow read: if isSignedIn();

      // Only Admin can create users (add agent)
      allow create: if isAdmin();

      // Only Admin can delete users
      allow delete: if isAdmin();

      // Admin can update ANY user fields
      allow update: if isAdmin();

      // Subuser can update ONLY their own NON-sensitive fields
      allow update: if isSignedIn()
                 && request.auth.uid == userId
                 && !(
                       "role" in request.resource.data ||
                       "password" in request.resource.data
                     );
    }

    /* -----------------------------
       ADMIN SETTINGS
    ------------------------------*/
    match /admin/{docId} {
      allow read, write: if isAdmin();
    }

    /* -----------------------------
       Default DENY for everything else
    ------------------------------*/
    match /{document=**} {
      allow read, write: if false;
    }
  }
}