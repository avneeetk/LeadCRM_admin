rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ------------------------------------
    // HELPERS
    // ------------------------------------
    function signedIn() {
      return request.auth != null;
    }

    function userRole() {
    return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return userRole() == "admin";
    }

    function isAgent() {
      return userRole() == "subuser";
    }

    // Helper to get assigned agent for a lead, handling both field naming conventions
    function getLeadAssignedTo(leadId) {
      let lead = get(/databases/$(database)/documents/leads/$(leadId));
      return lead.data.assignedTo || lead.data.assigned_to;
    }

    // ------------------------------------
    // LEADS
    // ------------------------------------
    match /leads/{leadId} {

  // LIST queries (collection reads)
  allow list: if signedIn() && (
    isAdmin() ||
    (isAgent() && request.auth.uid == resource.data.assignedTo)
  );

  // GET a single document
  allow get: if signedIn() && (
    isAdmin() ||
    request.auth.uid == resource.data.assignedTo
  );

  // CREATE
  allow create: if isAdmin() || isAgent();

  // UPDATE
  allow update: if
    (
      isAdmin() // admin can update everything
    ) || (
      // Agent can update only safe fields on their own leads
      isAgent() &&
      request.auth.uid == resource.data.assignedTo &&
      request.resource.data.diff(resource.data).changedKeys().hasOnly([
        "status",
        "tag",
        "updatedAt",
        "address",
        "city",
        "state",
        "country",
        "email",
        "phone",
        "name",
        "remarks",
        "followUpDate",
        "followUpTime"
      ])
    );

  // DELETE only admin
  allow delete: if isAdmin();
}

    // ðŸ”¹ Subcollection notes under a lead
    match /leads/{leadId}/notes/{noteId} {
      // ðŸŸ¢ READ:
      // Agents can read notes if they are assigned to this lead
      // Admins can read all
      allow read: if signedIn() &&
        (
          // admin users can read all notes
          isAdmin() ||
          // assigned agent can read
          get(/databases/$(database)/documents/leads/$(leadId)).data.assignedTo == request.auth.uid
        );

      // ðŸŸ¢ CREATE:
      // Agent can create a note if:
      //   - They are assigned to this lead
      //   - "by" equals their uid
      //   - "text" exists and is a string
      allow create: if signedIn() &&
        (
          get(/databases/$(database)/documents/leads/$(leadId)).data.assignedTo == request.auth.uid
        )
        && request.resource.data.keys().hasAll(['text', 'createdAt', 'by'])
        && request.resource.data.by == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0;

      // ðŸ›‘ UPDATE & DELETE:
      // Only admin can edit/delete notes
      allow update, delete: if isAdmin();
    }

    // ------------------------------------
    // LEGACY / TOP-LEVEL lead_notes collection
    // ------------------------------------
    match /lead_notes/{noteId} {
      // Read allowed for admins or the agent assigned to that lead
      allow read: if signedIn() && (
        isAdmin() ||
        // resource available on read; check the referenced lead's assigned agent
        (resource.data.lead_id != null && (
          get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assignedTo == request.auth.uid ||
          get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assigned_to == request.auth.uid
        ))
      );

      // Admins can manage all
      allow create, update, delete: if isAdmin();

      // Agents can create notes for leads they are assigned to. Accepts `{ lead_id, sender_id, message }` schema.
      allow create: if signedIn() && (
        resource.data.lead_id is string &&
        (get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assignedTo == request.auth.uid ||
         get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assigned_to == request.auth.uid)
        && request.resource.data.keys().hasAll(['lead_id','sender_id','message'])
        && request.resource.data.sender_id == request.auth.uid
        && request.resource.data.message is string
        && request.resource.data.message.size() > 0
      );

      // Agents may update their own legacy notes (only message field)
      allow update: if signedIn() && resource.data.sender_id == request.auth.uid && request.resource.data.keys().hasOnly(['message']);
    }

    // ------------------------------------
    // ATTENDANCE
    // ------------------------------------
    match /attendance/{attId} {

      // Logged-in users can read attendance (useful for admin dashboards and employee view)
      allow read: if signedIn();

      // User can create their own attendance documents; require userId match if provided
      allow create: if signedIn() && (
        !('userId' in request.resource.data) || request.auth.uid == request.resource.data.userId
      );

      // Admins can modify anything
      allow update, delete: if isAdmin();

      // A user can update ONLY their own attendance document
      allow update: if signedIn()
        && resource.data.userId == request.auth.uid;
    }

    // ------------------------------------
    // USERS
    // ------------------------------------
    match /users/{userId} {
      // Anyone logged in can read users (needed for assignedTo names)
      allow read: if signedIn();

      // Admin full control
      allow create, delete, update: if isAdmin();

      // Users can update ONLY their own safe profile fields
      allow update: if signedIn()
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          "name",
          "phone",
          "gender",
          "dateOfBirth",
          "address",
          "active",
          "updatedAt"
        ]);

      // NOTE: agent/stat fields (assignedLeads, closedDeals, etc.) must NOT be writable by clients.
      // Those fields should be maintained by trusted server code (Cloud Functions) using the Admin SDK.
    }

    // ------------------------------------
    // LEAD SOURCES
    // ------------------------------------
    match /lead_sources/{docId} {
      allow read: if signedIn();     // Needed for dropdowns
      allow write: if isAdmin();
    }

    // ------------------------------------
    // LEAD PURPOSES
    // ------------------------------------
    match /lead_purposes/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // ------------------------------------
    // INVOICES
    // ------------------------------------
    match /invoices/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ------------------------------------
    // BANK DETAILS
    // ------------------------------------
    match /bankDetails/{docId} {
      allow read, write: if isAdmin();
    }

    // ------------------------------------
    // ADMIN SETTINGS
    // ------------------------------------
    match /admin/{docId} {
      allow read, write: if isAdmin();
    }

    // ------------------------------------
    // DENY EVERYTHING ELSE
    // ------------------------------------
    match /{path=**} {
      allow read, write: if false;
    }
  }
}