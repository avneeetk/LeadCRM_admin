rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ------------------------------------
    // HELPERS
    // ------------------------------------
    function signedIn() {
      return request.auth != null;
    }

    function userRole() {
  return exists(/databases/$(database)/documents/users/$(request.auth.uid))
    ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
    : null;
}

    function isAdmin() {
      return userRole() == "admin";
    }

    function isAgent() {
      return userRole() == "subuser";
    }

    // Helper to get assigned agent for a lead, handling both field naming conventions
    function getLeadAssignedTo(leadId) {
      let lead = get(/databases/$(database)/documents/leads/$(leadId));
      return lead.data.assignedTo || lead.data.assigned_to;
    }

    // ------------------------------------
    // LEADS
    // ------------------------------------
    match /leads/{leadId} {

  // LIST queries (collection reads)
  allow list: if signedIn() && (
    isAdmin() ||
    isAgent() 
  );

  // GET a single document
 allow get: if signedIn() && (
  isAdmin() ||
  resource.data.assignedUsers.hasAny([request.auth.uid])
);

  // CREATE
  allow create: if isAdmin() || isAgent();

  // UPDATE
  allow update: if
  // ‚úÖ Admin: full control
  isAdmin()

  // ‚úÖ Assigned subuser: limited safe updates
  || (
    isAgent()
    && resource.data.assignedUsers.hasAny([request.auth.uid])
    && request.resource.data.diff(resource.data).changedKeys().hasOnly([
      "status",
      "tag",
      "updatedAt",
      "statusChangedAt",
      "followUpDate",
      "followUpTime",
      "remarks"
    ])
  );

  // DELETE only admin
  allow delete: if isAdmin();
}

    // ------------------------------------
    // LEAD STATUSES
    // ------------------------------------
    match /lead_statuses/{statusId} {
      // Allow read if user is authenticated
      allow read: if signedIn();
      
      // Allow write only for admin users
      allow write: if isAdmin();
    }

    // üîπ Subcollection notes under a lead
    match /leads/{leadId}/notes/{noteId} {
      // üü¢ READ:
      // Agents can read notes if they are assigned to this lead
      // Admins can read all
      allow read: if signedIn() &&
        (
          // admin users can read all notes
          isAdmin() ||
          // assigned agent can read
          get(/databases/$(database)/documents/leads/$(leadId)).data.assignedTo == request.auth.uid
        );

      // üü¢ CREATE:
      // Agent can create a note if:
      //   - They are assigned to this lead
      //   - "by" equals their uid
      //   - "text" exists and is a string
      allow create: if signedIn() &&
        (
          get(/databases/$(database)/documents/leads/$(leadId)).data.assignedTo == request.auth.uid
        )
        && request.resource.data.keys().hasAll(['text', 'createdAt', 'by'])
        && request.resource.data.by == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0;

      // üõë UPDATE & DELETE:
      // Only admin can edit/delete notes
      allow update, delete: if isAdmin();
    }

    // ------------------------------------
    // LEGACY / TOP-LEVEL lead_notes collection
    // ------------------------------------
    match /lead_notes/{noteId} {
      // Read allowed for admins or the agent assigned to that lead
      allow read: if signedIn() && (
        isAdmin() ||
        // resource available on read; check the referenced lead's assigned agent
        (resource.data.lead_id != null && (
          get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assignedTo == request.auth.uid ||
          get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assigned_to == request.auth.uid
        ))
      );

      // Admins can manage all
      allow create, update, delete: if isAdmin();

      // Agents can create notes for leads they are assigned to. Accepts `{ lead_id, sender_id, message }` schema.
      allow create: if signedIn() && (
        resource.data.lead_id is string &&
        (get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assignedTo == request.auth.uid ||
         get(/databases/$(database)/documents/leads/$(resource.data.lead_id)).data.assigned_to == request.auth.uid)
        && request.resource.data.keys().hasAll(['lead_id','sender_id','message'])
        && request.resource.data.sender_id == request.auth.uid
        && request.resource.data.message is string
        && request.resource.data.message.size() > 0
      );

      // Agents may update their own legacy notes (only message field)
      allow update: if signedIn() && resource.data.sender_id == request.auth.uid && request.resource.data.keys().hasOnly(['message']);
    }

    // ------------------------------------
    // ATTENDANCE
    // ------------------------------------
    match /attendance/{attendanceId} {
  // üîç Read - Any signed-in user can read attendance
  allow read: if signedIn();

  // ‚ûï Create
  // Agents can create:
  //  - punch-in attendance records
  //  - leave / half-day requests
  allow create: if signedIn()
    && request.resource.data.user_id == request.auth.uid
    && request.resource.data.record_type in ["attendance", "leave"]
    && (request.resource.data.start_date is timestamp || !('start_date' in request.resource.data))
    && (request.resource.data.end_date is timestamp || !('end_date' in request.resource.data));

  // ‚úèÔ∏è Update
  allow update: if
    // ‚úÖ Admin full control
    isAdmin()

    // ‚úÖ Agent punch-in / punch-out updates ONLY
    || (
      resource.data.user_id == request.auth.uid
      && request.resource.data.diff(resource.data).changedKeys().hasOnly([
        "punch_out_time",
        "punch_out_location",
        "punch_out_address",
        "updated_at",
        "start_date",
        "end_date"
      ])
      && (!('start_date' in request.resource.data) || request.resource.data.start_date is timestamp)
      && (!('end_date' in request.resource.data) || request.resource.data.end_date is timestamp)
    );

  // ‚ùå Delete (Admin only)
  allow delete: if isAdmin();
}

    // ------------------------------------
    // USERS
    // ------------------------------------
    match /users/{userId} {
      // Anyone logged in can read users (needed for assignedTo names)
      allow read: if signedIn();

      // Admin full control
      allow create, delete, update: if isAdmin();

      // Users can update ONLY their own safe profile fields
      allow update: if signedIn()
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          "name",
          "phone",
          "gender",
          "dateOfBirth",
          "address",
          "active",
          "updatedAt"
        ]);

      // NOTE: agent/stat fields (assignedLeads, closedDeals, etc.) must NOT be writable by clients.
      // Those fields should be maintained by trusted server code (Cloud Functions) using the Admin SDK.
    }

    // ------------------------------------
    // LEAD SOURCES
    // ------------------------------------
    match /lead_sources/{docId} {
      allow read: if signedIn();     // Needed for dropdowns
      allow write: if isAdmin();
    }

    // ------------------------------------
    // LEAD PURPOSES
    // ------------------------------------
    match /lead_purposes/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // ------------------------------------
    // INVOICES
    // ------------------------------------
    match /invoices/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ------------------------------------
    // BANK DETAILS
    // ------------------------------------
    match /bankDetails/{docId} {
      allow read, write: if isAdmin();
    }

    // ------------------------------------
    // ADMIN SETTINGS
    // ------------------------------------
    match /admin/{docId} {
      allow read, write: if isAdmin();
    }

    // ------------------------------------
    // DENY EVERYTHING ELSE
    // ------------------------------------
    match /{path=**} {
      allow read, write: if false;
    }
  }
}